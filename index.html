<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Page Visibility 2
    </title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c-common" class=
    "remove">
    </script>
    <script class='remove'>
    //make tidy happy
    var respecConfig = {
    previousPublishDate: "2013-10-29",
    previousMaturity: 'WD',
    specStatus: 'ED',
    prevVersion: 'WD',
    shortName: 'page-visibility',
    editors: [{
      name: 'Arvind Jain',
      company: 'Google Inc.,',
      companyURL: 'https://google.com/',
    }, {
      name: 'Jatinder Mann',
      company: 'Microsoft Corp.',
      companyURL: 'https://microsoft.com',
    }],
    edDraftURI: 'https://w3c.github.io/page-visibility/',
    wg: 'Web Performance Working Group',
    wgURI: 'http://www.w3.org/2010/webperf/',
    wgPublicList: 'public-web-perf',
    wgPatentURI: 'http://www.w3.org/2004/01/pp-impl/45211/status',
    noLegacyStyle: true,
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/page-visibility'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/page-visibility/issues'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/page-visibility/commits/gh-pages'
      }, {
        value: 'Mailing list.',
        href: 'https://lists.w3.org/Archives/Public/public-web-perf/'
      }]
    }],
    };
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>
        This specification defines a means to programmatically determine the
        visibility state of a document. This can aid in the development of
        power and CPU efficient web applications.
      </p>
    </section>
    <section id="sotd">
      <p>
        This is a <strong>work in progress</strong> and may change without any
        notices.
      </p>
    </section>
    <section id="introduction">
      <h2>
        Introduction
      </h2>
      <p>
        The <cite>Page Visibility API</cite> defines a means to
        programmatically determine the <a title="visibility states">visibility
        state</a> of a top level browsing context, and to be notified if the
        <a title="visibility states">visibility state</a> changes. Without
        knowing the <a title="visibility states">visibility state</a> of a
        page, web developers have been designing web pages as if they are
        always <a>visible</a>. This not only results in higher machine resource
        utilization, but it prevents web developers from making runtime
        decisions based on whether the web page is <a>visible</a> to the user.
        Designing web pages with knowledge of the page's <a title=
        "visibility states">visibility state</a> can result in improved user
        experiences and power efficient sites.
      </p>
      <p>
        With this API, web applications can choose to alter their behavior
        based on whether they are <a>visible</a> to the user or not. For
        example, this API can be used to scale back work when the page is no
        longer <a>visible</a>.
      </p>
    </section>
    <section>
      <h2>
        Examples of usage
      </h2>
      <p>
        To improve the user experience and optimize CPU and power efficiency
        the application could autoplay a video when the application is
        <a>visible</a>, and automatically pause the playback when the
        application is <a>hidden</a>:
      </p>
      <pre class="example highlight" title="Visibility-aware video playback">
      var videoElement = document.getElementById("videoElement");

      // Autoplay the video if application is visible
      if (!document.hidden) {
        videoElement.play();
      }

      // Handle page visibility change events
      function handleVisibilityChange() {
        if (document.hidden) {
          videoElement.pause();
        } else {
          videoElement.play();
        }
      }

      document.addEventListener(visibilityChange, handleVisibilityChange, false);
</pre>
      <p>
        Similar logic can be applied to intellegently pause and resume, or
        throttle, execution of application code such as animation loops,
        analytics, and other types of processing. By combining the
        <code>hidden</code> attribute of the <a>Document</a> interface and the
        <code>visibilitychange</code> event, the application is able to both
        query and listen to page visibility events to deliver a better user
        experience, as well as improve efficiency and performance of its
        execution.
      </p>
    </section>
    <section>
      <h2>
        Visibility states and the <code>VisibilityState</code> enum
      </h2>
      <p>
        The <a>Document</a> of the <a>top level browsing context</a> can be in
        one of the following <dfn>visibility states</dfn>:
      </p>
      <dl>
        <dt>
          <dfn id="idl-def-.hidden">hidden</dfn>
        </dt>
        <dd>
          The <a>Document</a> is not <a>visible</a> at all on any screen.
        </dd>
        <dt>
          <dfn id="idl-def-.visible">visible</dfn>
        </dt>
        <dd>
          The <a>Document</a> is at least partially visible on at least one
          screen. This is the same condition under which the
          <code>hidden</code> attribute is set to <code>false</code>.
        </dd>
        <dt>
          <dfn id="idl-def-.prerender">prerender</dfn>
        </dt>
        <dd>
          The <a>Document</a> is loaded in the prerender mode and is not yet
          visible. User agent support of the <code>prerender</code> return
          value of the <a>visibilityState</a> attribute is OPTIONAL.
        </dd>
        <dt>
          <dfn id="idl-def-.unloaded">unloaded</dfn>
        </dt>
        <dd>
          The user agent is to <a>unload</a> the <a>Document</a>. User agent
          support of the <code>unloaded</code> return value of the
          <a>visibilityState</a> attribute is OPTIONAL.
        </dd>
      </dl>
      <p>
        The <a>visibility states</a> are reflected in the API via the
        <a>VisibilityState</a> enum.
      </p>
      <pre class="idl">
      enum VisibilityState {
        "hidden", "visible", "prerender", "unloaded"
      };
</pre>
    </section>
    <section>
      <h2>
        Extensions to the <a>Document</a> interface
      </h2>
      <p>
        This specification extends the [[!HTML5]] <a>Document</a> interface:
      </p>
      <pre class="idl">
      partial interface Document {
        readonly attribute boolean hidden;
        readonly attribute VisibilityState visibilityState;
      };
</pre>
      <section>
        <h3>
          <code>hidden</code> attribute
        </h3>
        <p>
          On getting, the <code>hidden</code> attribute MUST run the <dfn>steps
          to determine if the document is hidden</dfn>:
        </p>
        <ol>
          <li>Let <var>doc</var> be the <code>Document</code> of the <a>top
          level browsing context</a>.
          </li>
          <li>If the <code>defaultView</code> of <var>doc</var> is
          <code>null</code>, return <code>true</code>.
          </li>
          <li>if <var>doc</var> is <a>hidden</a>, return <code>true</code>.
          </li>
          <li>Otherwise, return <code>false</code>.
          </li>
        </ol>
        <p>
          To accommodate assistive technologies that are typically full screen
          but still show a view of the page, when applicable, the
          <code>hidden</code> attribute MAY return <code>false</code> when the
          user agent is not minimized but is fully obscured by other
          applications.
        </p>
        <div class="example">
          <p>
            As examples, on getting, the <code>hidden</code> attribute returns
            <code>true</code> when:
          </p>
          <ul>
            <li>The user agent is minimized.
            </li>
            <li>The user agent is not minimized, but the page is on a
            background tab.
            </li>
            <li>The user agent is about to unload the page.
            </li>
            <li>The user agent is about to traverse to a session history entry.
            </li>
            <li>The operating system's lock screen is shown.
            </li>
          </ul>
          <p>
            Likewise, as examples, on getting, the <code>hidden</code>
            attribute returns <code>false</code> when:
          </p>
          <ul>
            <li>The user agent is not minimized and the page is on a foreground
            tab.
            </li>
            <li>The user agent is fully obscured by an accessibility tool, like
            a magnifier, but a view of the page is shown.
            </li>
          </ul>
        </div>
      </section>
      <section>
        <h3>
          <code>visibilityState</code> attribute
        </h3>
        <p>
          On getting, the <code>visibilityState</code> attribute the user agent
          MUST run the <dfn>steps to determine the visibility state</dfn>:
        </p>
        <ol>
          <li>Let <var>doc</var> be the <code>Document</code> of the <a>top
          level browsing context</a>.
          </li>
          <li>If the <code>defaultView</code> of <var>doc</var> is
          <code>null</code>, return <code>hidden</code>.
          </li>
          <li>Otherwise, return the <a>VisibilityState</a> value that best
          matches the <a title="visibility states">visibility state</a>
          <var>doc</var>.
          </li>
        </ol>
        <p>
          To accommodate assistive technologies that are typically full screen
          but still show a view of the page, when applicable, on getting, the
          <code>visibilityState</code> attribute MAY return
          <code>visible</code>, instead of <code>hidden</code>, when the user
          agent is not minimized but is fully obscured by other applications.
        </p>
        <div class="note">
          <p>
            For example, in the following cases the
            <code>visibilityState</code> attribute would return
            <code>hidden</code>:
          </p>
          <ul>
            <li>The user agent is minimized.
            </li>
            <li>The user agent is not minimized, but the page is on a
            background tab.
            </li>
            <li>The Operating System lock screen is shown.
            </li>
          </ul>
        </div>
      </section>
    </section>
    <section>
      <h2>
        Reacting to visibility changes
      </h2>
      <p>
        The <a>task source</a> for these <a title="task">tasks</a> is the
        <a>animation task source</a>.
      </p>
      <p>
        When the user agent determines that the visibility of the
        <a>Document</a> of the <a>top level browsing context</a> has changed,
        the user agent MUST run the following steps:
      </p>
      <ol>
        <li>Let <var>doc</var> be the <a>Document</a> of the <a>top level
        browsing context</a>.
        </li>
        <li>If <var>doc</var> is <a>visible</a>:
          <ol>
            <li>If traversing to a <a>session history entry</a>, run the <a>now
            visible algorithm</a> before running the step to fire the
            <code>pageshow</code> event.
            </li>
            <li>Otherwise, <a>queue a task</a> that runs the <a>now visible
            algorithm</a>.
            </li>
          </ol>
        </li>
        <li>Else if <var>doc</var> is now not <a>visible</a>, or if the user
        agent is to <a>unload</a> <var>doc</var>:
          <ol>
            <li>If the user agent is to <a>unload</a> the <a>Document</a>, run
            the <a>now hidden algorithm</a> during the <a>unloading document
            visibility change steps</a>,
            </li>
            <li>Otherwise, <a>queue a task</a> that runs the <a>now hidden
            algorithm</a>.
            </li>
          </ol>
        </li>
      </ol>
      <p>
        The <dfn>now visible algorithm</dfn> runs the following steps
        synchronously:
      </p>
      <ol>
        <li>Let <var>doc</var> be the <a>Document</a> of the <a>top level
        browsing context</a>.
        </li>
        <li>Set the <code>hidden</code> attribute to <code>false</code>.
        </li>
        <li>Set the <code>visibilityState</code> attribute to
        <code>visible</code>.
        </li>
        <li>
          <a>Fire a simple event</a> named <code>visibilitychange</code> that
          bubbles, isn't cancelable, and has no default action, at
          <var>doc</var>.
        </li>
      </ol>
      <p>
        The <dfn>now hidden algorithm</dfn> runs the following steps
        synchronously:
      </p>
      <ol>
        <li>Let <var>doc</var> be the <a>Document</a> of the <a>top level
        browsing context</a>.
        </li>
        <li>Set the <code>hidden</code> attribute to <code>true</code>.
        </li>
        <li>Set the <code>visibilityState</code> attribute to
        <code>hidden</code>. If the user agent is to <a>unload</a> the
        <a>Document</a>, set the <code>visibilityState</code> attribute to
        <code>unloaded</code>. Setting <code>visibilityState</code> attribute
        to <code>unloaded</code> instead of <code>hidden</code> is OPTIONAL.
        </li>
        <li>
          <a>Fire a simple event</a> named <code>visibilitychange</code> that
          bubbles, isn't cancelable, and has no default action, at the
          <var>doc</var>.
        </li>
      </ol>
    </section>
    <section id="privacy">
      <h2>
        Privacy
      </h2>
      <p>
        The <cite>Page Visibility API</cite> enables third party content on a
        web page to determine the visibility of the <a>Document</a> contained
        by the <a>top level browsing context</a> with higher precision compared
        to existing mechanisms, like <a>focus</a> or <a>blur</a> events.
        However, for practical considerations, the additional exposure is not
        substantial.
      </p>
    </section>
    <section>
      <h3>
        Terminology
      </h3>
      <p>
        The following concepts and interfaces are defined in the [[!HTML5]]
        specification:
      </p>
      <ul>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/browsers.html#dom-document-defaultview"><code>
          defaultView</code></a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/browsers.html#event-pageshow"><code>pageshow</code></a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/browsers.html#session-history-entry">session
          history entry</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/browsers.html#top-level-browsing-context">
          top level browsing context</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/browsers.html#unloading-document-visibility-change-steps">
          unloading document visibility change steps</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/browsers.html#unloading-documents">unload</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/dom.html#document">Document</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/editing.html#focus-management">blur</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/editing.html#focus-management">focus</a></dfn>
        </li>
        <li>
          <a href=
          "https://www.whatwg.org/specs/web-apps/current-work/#queue-a-task"><dfn>
          queue a task</dfn></a>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/webappapis.html#task-source">task
          source</a></dfn>
        </li>
        <li>
          <dfn><a href=
          "http://www.w3.org/TR/html5/webappapis.html#concept-task">task</a></dfn>
        </li>
      </ul>
      <p>
        The [[!animation-timing]] specification defines the <dfn><a href=
        "http://w3c.github.io/animation-timing/#dfn-animation-task-source">animation
        task source</a></dfn>.
      </p>
      <p>
        The [[!DOM4]] specification defines how to <dfn><a href=
        "https://dom.spec.whatwg.org/#concept-event-fire">fire a simple
        event</a></dfn>.
      </p>
    </section>
    <section class="appendix">
      <h2>
        Acknowledgments
      </h2>
      <p>
        We would like to sincerely thank Karen Anderson, Nic Jansma, Alex
        Komoroske, Cameron McCormack, James Robinson, Jonas Sicking, Kyle
        Simpson, Jason Weber, and Boris Zbarsky to acknowledge their
        contributions to this work.
      </p>
    </section>
    <section id="conformance" class="appendix"></section>
  </body>
</html>
